# Copyright (c) 2020, Solace Corporation, Ricardo Gomez-Ulmke, <ricardo.gomez-ulmke@solace.com>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)
---
- set_fact:
    broker_url: "{{ 'https' if sempv2_is_secure_connection else 'http' }}://{{ sempv2_host }}:{{ sempv2_port }}"
  when: service_type == 'docker_single_node'
  delegate_to: localhost

- name: "Wait for Broker Up"
  uri:
    url: "{{ broker_url }}"
    return_content: yes
    status_code: [200, -1]
  register: result
  until: result.status == 200
  retries: 20
  delay: 5
  when: service_type == 'docker_single_node'
  delegate_to: localhost

- assert:
    that: result.status == 200
    fail_msg: "cannot reach broker on {{ broker_url }}"
  when: service_type == 'docker_single_node'
  delegate_to: localhost

# check if spool is fully activated, using create a queue as test
- name: "Check if message spool is available"
  solace.pubsub_plus.solace_queue:
    host: "{{ sempv2_host }}"
    port: "{{ sempv2_port }}"
    secure_connection: "{{ sempv2_is_secure_connection }}"
    username: "{{ sempv2_username }}"
    password: "{{ sempv2_password }}"
    msg_vpn: "{{ vpn }}"
    name: test_message_spool
    state: present
  register: result
  until: result.rc == 0
  retries: 20
  delay: 5
  when: service_type == 'docker_single_node'
  delegate_to: localhost

- assert:
    that: result.rc == 0
    fail_msg: "failed to create queue: {{ result.msg }}"
  when: service_type == 'docker_single_node'
  delegate_to: localhost

- name: "clean up queue"
  solace.pubsub_plus.solace_queue:
    host: "{{ sempv2_host }}"
    port: "{{ sempv2_port }}"
    secure_connection: "{{ sempv2_is_secure_connection }}"
    username: "{{ sempv2_username }}"
    password: "{{ sempv2_password }}"
    msg_vpn: "{{ vpn }}"
    name: test_message_spool
    state: absent
  when: service_type == 'docker_single_node'
  delegate_to: localhost

- name: create inventory
  set_fact:
    inventory: "{{ lookup('template', 'docker_single_node.j2') | from_json}}"
  when: service_type == 'docker_single_node'
  delegate_to: localhost

- name: "Write Generated Inventory"
  copy:
    content: "{{ inventory | to_nice_yaml(indent=2) }}"
    dest: "{{ generated_inventory_file }}"
  delegate_to: localhost
