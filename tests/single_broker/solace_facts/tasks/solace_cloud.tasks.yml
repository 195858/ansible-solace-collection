# Copyright (c) 2020, Solace Corporation, Ricardo Gomez-Ulmke, <ricardo.gomez-ulmke@solace.com>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

-
- name: "solace_cloud: Gather Solace Facts"
  solace_gather_facts:

- name: "solace_cloud: Save 'ansible_facts.solace' to File"
  copy:
    content: "{{ ansible_facts.solace | to_nice_json }}"
    dest: "{{ working_dir }}/facts.{{ inventory_hostname }}.json"
  delegate_to: localhost
      # no_log: true

- name: "solace_cloud: solace_get_facts"
  solace_get_facts:
    hostvars: "{{ hostvars }}"
    host: "{{ inventory_hostname }}"
    field_funcs:
      - get_serviceSmfPlainTextListenPort
      - get_serviceSmfCompressionListenPort
      - get_serviceSmfTlsListenPort
      - get_virtualRouterName
      - get_serviceSMFMessagingEndpoints
      - get_bridge_remoteMsgVpnLocations
      - get_allClientConnectionDetails
  register: result
- debug:
    msg:
      - facts
      - "{{ result.facts }}"
- assert:
    that:
      - result.facts.serviceSmfPlainTextListenPort is defined
      - result.facts.serviceSmfCompressionListenPort is defined
      - result.facts.serviceSmfTlsListenPort is defined
      - result.facts.virtualRouterName is defined
      - result.facts.serviceMessagingEndpoints is defined
      - result.facts.bridge_remoteMsgVpnLocations is defined
      - result.facts.clientConnectionDetails is defined

- set_fact:
    content: "{{ result.facts.serviceSmfPlainTextListenPort }}"
    dest: "{{ working_dir }}/solace_cloud.facts.{{ inventory_hostname }}.serviceSmfPlainTextListenPort.json"
- copy:
    content: "{{ content  | to_nice_json }}"
    dest: "{{ dest }}"
  delegate_to: localhost

- set_fact:
    content: "{{ result.facts.serviceSmfCompressionListenPort }}"
    dest: "{{ working_dir }}/solace_cloud.facts.{{ inventory_hostname }}.serviceSmfCompressionListenPort.json"
- copy:
    content: "{{ content  | to_nice_json }}"
    dest: "{{ dest }}"
  delegate_to: localhost

- set_fact:
    content: "{{ result.facts.serviceSmfTlsListenPort }}"
    dest: "{{ working_dir }}/solace_cloud.facts.{{ inventory_hostname }}.serviceSmfTlsListenPort.json"
- copy:
    content: "{{ content  | to_nice_json }}"
    dest: "{{ dest }}"
  delegate_to: localhost

- set_fact:
    content: "{{ result.facts.virtualRouterName }}"
    dest: "{{ working_dir }}/solace_cloud.facts.{{ inventory_hostname }}.virtualRouterName.json"
- copy:
    content: "{{ content  | to_nice_json }}"
    dest: "{{ dest }}"
  delegate_to: localhost

- set_fact:
    content: "{{ result.facts.serviceMessagingEndpoints }}"
    dest: "{{ working_dir }}/solace_cloud.facts.{{ inventory_hostname }}.serviceMessagingEndpoints.json"
- copy:
    content: "{{ content  | to_nice_json }}"
    dest: "{{ dest }}"
  delegate_to: localhost

- set_fact:
    content: "{{ result.facts.bridge_remoteMsgVpnLocations }}"
    dest: "{{ working_dir }}/solace_cloud.facts.{{ inventory_hostname }}.bridge_remoteMsgVpnLocations.json"
- copy:
    content: "{{ content  | to_nice_json }}"
    dest: "{{ dest }}"
  delegate_to: localhost

- set_fact:
    content: "{{ result.facts.clientConnectionDetails }}"
    dest: "{{ working_dir }}/solace_cloud.facts.{{ inventory_hostname }}.clientConnectionDetails.json"
- copy:
    content: "{{ content  | to_nice_json }}"
    dest: "{{ dest }}"
  delegate_to: localhost


###
# The End.
