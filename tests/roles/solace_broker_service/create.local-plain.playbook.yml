# Copyright (c) 2021, Solace Corporation, Ricardo Gomez-Ulmke, <ricardo.gomez-ulmke@solace.com>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

-
  name: "create: broker_service"
  hosts: all
  gather_facts: no
  any_errors_fatal: true
  pre_tasks:
  - include_vars:
      file: "env.vars.yml"
      name: env
  vars:
    broker_project_name: test_roles_local_broker_service_single_node
  tasks:
    - name: "Check vars"
      set_fact:
        target_inventory_file: "{{ WORKING_DIR }}/{{ env.local_broker_inventory_file_name }}"

      # TODO: test using custom docker compose file
      # definition: "{{ lookup('file', broker_docker_compose_file) | from_yaml }}"


    - name: "Broker Service Delete"
      include_role:
        name: solace.pubsub_plus.solace_broker_service
      vars:
        service_type: docker_single_node
        state: absent
        project_name: "{{ broker_project_name }}"
        generated_inventory_file: "{{ target_inventory_file }}"

    # - name: "Broker Service Setup - HTTP"
    #   include_role:
    #     name: solace.pubsub_plus.solace_broker_service
    #   vars:
    #     service_type: docker_single_node
    #     state: present
    #     project_name: "{{ broker_project_name }}"
    #     container_name: "pubSubStandardSingleNode"
    #     image: "{{ BROKER_DOCKER_IMAGE }}"
    #     generated_inventory_file: "{{ genenrated_inventory_file }}"

    # - name: "Broker Service Delete"
    #   include_role:
    #     name: solace.pubsub_plus.solace_broker_service
    #   vars:
    #     service_type: docker_single_node
    #     state: absent
    #     project_name: "{{ broker_project_name }}"
    #     generated_inventory_file: "{{ genenrated_inventory_file }}"

    # - set_fact:
    #     broker_docker_compose_file: "files/PubSubStandard_singleNodeSecure.yml"

    - name: "Broker Service Setup - HTTPS"
      include_role:
        name: solace.pubsub_plus.solace_broker_service
      vars:
        service_type: docker_single_node
        project_name: "{{ broker_project_name }}"
        container_name: "pubSubStandardSingleNodeHttps"
        image: "{{ BROKER_DOCKER_IMAGE }}"
        generated_inventory_file: "{{ target_inventory_file }}"
        sempv2_host: localhost
        sempv2_port: 1943
        sempv2_is_secure_connection: True
        host_mount_path_secrets: host path
        server_certificate_file: path to pem file
        state: present
        definition:
          version: '3.3'
          services:
            primary:
              container_name: "{{ container_name }}"
              image: "{{ image }}"
              restart: unless-stopped
              shm_size: 1g
              ulimits:
                core: 2
                nofile:
                  soft: 2448
                  hard: 38048
              ports:
                #Web transport
                # - '80:80'
                #Web transport over TLS
                # - '443:443'
                #MQTT Default VPN
                # - '1883:1883'
                #AMQP Default VPN over TLS
                # - '5671:5671'
                #AMQP Default VPN
                # - '5672:5672'
                #MQTT Default VPN over WebSockets
                # - '8000:8000'
                #MQTT Default VPN over WebSockets / TLS
                # - '8443:8443'
                #MQTT Default VPN over TLS
                # - '8883:8883'
                #SEMP over TLS
                - "{{ sempv2_port }}:1943"
                #SEMP / PubSub+ Manager
                # - "{{ sempv2_port }}:8080"
                #REST Default VPN
                # - '9000:9000'
                #REST Default VPN over TLS
                # - '9443:9443'
                #SMF
                # - '55555:55555'
                #SMF Compressed
                # - '55003:55003'
                #SMF over TLS
                # - '55443:55443'
              environment:
                - "username_admin_globalaccesslevel={{ sempv2_username }}"
                - "username_admin_password={{ sempv2_password }}"
                - system_scaling_maxconnectioncount=100
                #- routername=ansible-solace__test

###
# The End.
